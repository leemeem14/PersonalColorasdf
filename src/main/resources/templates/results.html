<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>퍼스널 컬러 분석 결과</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-image: url("/images/mainpage.png");
            background-size: cover;
            background-attachment: fixed;
            min-height: 100vh;
        }
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1, p { text-align: center; margin: 8px 0; color: #333; }
        #stage {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-bottom: 30px;
            border: 3px solid #333;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        #resultImage {
            display: block;
            width: 100%;
            height: auto;
            border-radius: 9px;
        }

        @media (max-width: 768px) {
            .container { padding: 10px; }
            #stage { max-width: 100%; }
            .chart-grid { grid-template-columns: 1fr; }
            .info-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
        }

        .color-swatch {
            width: 50px;
            height: 50px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        .color-swatch:hover { transform: scale(1.1); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .color-swatch.selected { border: 3px solid #333; box-shadow: 0 0 10px rgba(0,0,0,0.5); transform: scale(1.15); }
        .color-swatch.selected::after {
            content: '✓';
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: white; font-weight: bold; font-size: 16px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        .charts-section { width: 100%; max-width: 800px; margin: 30px 0; padding: 20px; background: rgba(255, 255, 255, 0.9); border-radius: 10px; }
        .chart-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .chart-container {
            background: white; border-radius: 8px; padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); height: 300px; min-height: 280px;
        }
        canvas { width: 100% !important; height: 220px !important; min-height: 200px; }

        .recommendations-section { margin: 20px 0; padding: 15px; background: rgba(255, 255, 255, 0.8); border-radius: 10px; }
        .recommendations-section h3 { text-align: center; color: #333; margin-bottom: 15px; }
        .color-swatches { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; }

        #canvasOverlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; border-radius: 4px; }

        /* 토글 공통 */
        .hidden { display: none; }
        .toggle-buttons {
            display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-top: 16px;
        }
        .toggle-buttons button, .close-btn {
            padding: 10px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; border: 2px solid #333;
            background: #fff; color: #333; transition: all .2s ease;
        }
        .toggle-buttons button:hover, .close-btn:hover { background: #333; color: #fff; }

        /* 톤 설명 박스 */
        #toneDescriptionBox { background: #fff; border-radius: 10px; padding: 16px; box-shadow: 0 2px 6px rgba(0,0,0,.08); }
        #toneDescriptionBox h3 { margin-top: 8px; }
        #toneSection h2 { text-align: center; margin-bottom: 16px; color: #333; }
    </style>
</head>
<body>
<div class="container">
    <div id="stage">
        <img id="resultImage" th:src="@{'/files/' + ${analysis.storedFileName}}" alt="분석 이미지"/>
        <canvas id="canvasOverlay"></canvas>
    </div>

    <div class="result-header" style="text-align: center; margin-bottom: 16px; padding: 20px; background: rgba(255, 255, 255, 0.9); border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <h1 style="margin: 0 0 10px 0; color: #333; font-size: 28px;" th:text="${analysis.colorType.displayName} + ' - 당신의 퍼스널 컬러입니다'"></h1>
        <p style="margin: 0; color: #666; font-size: 16px; line-height: 1.5;" th:text="${description}"></p>
        <div style="margin-top: 15px; padding: 10px; background: rgba(54, 162, 235, 0.1); border-radius: 8px; border-left: 4px solid #36A2EB;">
            <p style="margin: 0; color: #333; font-weight: bold; font-size: 14px;">
                신뢰도: <span th:text="${confidence} + '%'"></span>
                <span style="color: #666; font-weight: normal;">(품질: <span th:text="${qualityLevel}"></span>)</span>
            </p>
        </div>
    </div>

    <!-- 추천 색상 -->
    <div th:if="${recommendations != null && !recommendations.isEmpty()}" class="recommendations-section">
        <h3>🎨 추천 색상</h3>
        <p style="text-align: center; color: #666; margin-bottom: 20px; font-size: 14px;">아래 색상을 클릭하여 옷 색상 미리보기를 확인해보세요</p>
        <div class="color-swatches">
            <div th:each="color : ${recommendations}"
                 class="color-swatch"
                 th:style="'background-color:' + ${color}"
                 th:data-color="${color}"
                 th:title="'클릭하여 ' + ${color} + ' 색상 적용'">
            </div>
        </div>
        <div style="text-align: center; margin-top: 15px; padding: 10px; background: rgba(255, 255, 255, 0.7); border-radius: 8px;">
            <p style="margin: 0; color: #666; font-size: 12px;">💡 팁: 이미지 위를 클릭한 후 추천 색상을 선택하면 실제 색상 적용 효과를 볼 수 있습니다</p>
        </div>
    </div>

    <!-- 보기/닫기 토글 버튼 -->
    <div class="toggle-buttons">
        <button id="openDetailBtn" type="button">상세 분석 보기</button>
        <button id="closeDetailBtn" type="button" class="hidden">상세 분석 닫기</button>
        <button id="openToneBtn" type="button"> 추천 보기</button>
        <button id="closeToneBtn" type="button" class="hidden"> 추천 닫기</button>
    </div>

    <!-- 상세 분석: 초기 숨김 -->
    <section id="detailSection" class="charts-section hidden">
        <h2 style="text-align: center; margin-bottom: 30px; color: #333;">📊 상세 분석 결과</h2>
        <div class="chart-grid">
            <div class="chart-container">
                <h4 style="text-align: center; margin-bottom: 15px; color: #555;">신뢰도 분석</h4>
                <canvas id="confidenceChart" width="300" height="220"></canvas>
            </div>
            <div class="chart-container">
                <h4 style="text-align: center; margin-bottom: 15px; color: #555;">퍼스널 컬러 타입 비교</h4>
                <canvas id="typeComparisonChart" width="300" height="220"></canvas>
            </div>
        </div>

        <div class="analysis-details" style="margin-top: 30px; padding: 20px; background: rgba(255, 255, 255, 0.8); border-radius: 10px;">
            <h3 style="text-align: center; margin-bottom: 20px; color: #333;">분석 상세 정보</h3>
            <div class="info-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div class="info-item" style="padding: 15px; background: white; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <h4 style="margin: 0 0 10px 0; color: #666; font-size: 14px;">신뢰도</h4>
                    <p style="margin: 0; font-size: 24px; font-weight: bold; color: #333;" th:text="${confidence} + '%'"></p>
                    <p style="margin: 5px 0 0 0; font-size: 12px; color: #888;" th:text="'품질: ' + ${qualityLevel}"></p>
                </div>
                <div class="info-item" style="padding: 15px; background: white; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <h4 style="margin: 0 0 10px 0; color: #666; font-size: 14px;">분석 타입</h4>
                    <p style="margin: 0; font-size: 18px; font-weight: bold; color: #333;" th:text="${analysis.colorType.displayName}"></p>
                </div>
                <div class="info-item" style="padding: 15px; background: white; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <h4 style="margin: 0 0 10px 0; color: #666; font-size: 14px;">추천 색상 수</h4>
                    <p style="margin: 0; font-size: 24px; font-weight: bold; color: #333;" th:text="${#lists.size(recommendations)} + '개'"></p>
                </div>
                <div class="info-item" style="padding: 15px; background: white; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <h4 style="margin: 0 0 10px 0; color: #666; font-size: 14px;">분석 일시</h4>
                    <p style="margin: 0; font-size: 12px; color: #333;" th:text="${#temporals.format(analysisDate, 'yyyy-MM-dd HH:mm')}"></p>
                </div>
            </div>
        </div>
    </section>

    <!-- 퍼스널 컬러 타입별 특징: 초기 숨김 -->
    <section id="toneSection" class="charts-section hidden">
        <h2>퍼스널 컬러 추천</h2>
        <div id="toneDescriptionBox"></div>
    </section>

    <!-- 네비게이션 -->
    <div class="navigation-buttons" style="margin-top: 40px; display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
        <button onclick="window.location.href='/upload'"
                style="padding: 12px 24px; background: #fff; color: #333; border: 2px solid #333; border-radius: 8px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; font-size: 14px;">
            ← 새로운 분석하기
        </button>
        <button onclick="goToShopping()"
                style="padding: 12px 24px; background: #333; color: #fff; border: 2px solid #333; border-radius: 8px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; font-size: 14px;">
            쇼핑하러 가기 →
        </button>
    </div>
</div>

<script>
    function goToShopping() {
        const analysisId = /*[[${analysis.id}]]*/ null;
        if (analysisId) {
            window.location.href = '/shop?analysisId=' + analysisId;
        } else {
            window.location.href = '/shop';
        }
    }
</script>

<script th:inline="javascript">
    // 초기 차트/색상 기능 유지
    document.addEventListener('DOMContentLoaded', () => {
        const clothMaskUrl  = "/static/masks/";
        const personMaskUrl = "/static/pmasks/";
        initializeColorChangeFunctionality(clothMaskUrl, personMaskUrl);

        if (typeof Chart !== 'undefined') {
            initializeCharts();
        } else {
            const checkChart = setInterval(() => {
                if (typeof Chart !== 'undefined') { clearInterval(checkChart); initializeCharts(); }
            }, 100);
            setTimeout(() => { if (typeof Chart === 'undefined') { clearInterval(checkChart); console.error('Chart.js 로드 실패'); showChartError(); } }, 5000);
        }

        // 토글 버튼
        const detail = document.getElementById('detailSection');
        const tone   = document.getElementById('toneSection');

        const openDetailBtn  = document.getElementById('openDetailBtn');
        const closeDetailBtn = document.getElementById('closeDetailBtn');
        const openToneBtn    = document.getElementById('openToneBtn');
        const closeToneBtn   = document.getElementById('closeToneBtn');

        function show(el) { el && el.classList.remove('hidden'); }
        function hide(el) { el && el.classList.add('hidden'); }

        openDetailBtn?.addEventListener('click', () => {
            show(detail);
            hide(openDetailBtn);
            show(closeDetailBtn);
        });
        closeDetailBtn?.addEventListener('click', () => {
            hide(detail);
            show(openDetailBtn);
            hide(closeDetailBtn);
        });

        openToneBtn?.addEventListener('click', () => {
            show(tone);
            setToneDescription();
            hide(openToneBtn);
            show(closeToneBtn);
        });
        closeToneBtn?.addEventListener('click', () => {
            hide(tone);
            show(openToneBtn);
            hide(closeToneBtn);
        });

        // 내부 닫기 버튼에서 섹션 닫기 연결
        window.closeToneDescription = function() {
            hide(tone);
            show(openToneBtn);
            hide(closeToneBtn);
        };
    });

    // Chart.js 초기화 함수 (기존 코드 요약, 상세 구현은 그대로 유지 가능)
    function initializeCharts() {
        createConfidenceChart();
        createTypeComparisonChart();
    }
    function createConfidenceChart() {
        const ctx = document.getElementById('confidenceChart');
        if (!ctx) return;
        const confidence = /*[[${confidence}]]*/ 0;
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['신뢰도', '불확실성'],
                datasets: [{
                    data: [confidence, 100 - confidence],
                    backgroundColor: [
                        confidence > 70 ? '#4CAF50' : confidence > 50 ? '#FF9800' : '#F44336',
                        '#E0E0E0'
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
    }
    function createTypeComparisonChart() {
        const ctx = document.getElementById('typeComparisonChart');
        if (!ctx) return;
        const probabilities = /*[[${probabilities}]]*/ {};
        const labels = ['SPRING', 'SUMMER', 'AUTUMN', 'WINTER'];
        const typeLabels = ['봄 웜톤', '여름 쿨톤', '가을 웜톤', '겨울 쿨톤'];
        const data = labels.map(label => probabilities[label] || 0);
        new Chart(ctx, {
            type: 'radar',
            data: {
                labels: typeLabels,
                datasets: [{
                    label: '유사도 (%)',
                    data: data,
                    fill: true,
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 2,
                    pointBackgroundColor: 'rgba(54, 162, 235, 1)',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { r: { beginAtZero: true, max: 100, ticks: { stepSize: 20 } } },
                plugins: { legend: { position: 'bottom' } }
            }
        });
    }
    function showChartError() {
        const chartContainers = document.querySelectorAll('.chart-container');
        chartContainers.forEach(container => {
            const canvas = container.querySelector('canvas');
            if (canvas) {
                canvas.style.display = 'none';
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = 'display:flex;align-items:center;justify-content:center;height:100%;color:#666;font-size:14px;';
                errorDiv.textContent = '차트를 불러올 수 없습니다.';
                container.appendChild(errorDiv);
            }
        });
    }

    // 이미지 컬러 변경 시스템 (기존 함수 유지)
    function initializeColorChangeFunctionality(clothUrl, personUrl) {
        const resultImage = document.getElementById('resultImage');
        const canvas = document.getElementById('canvasOverlay');
        const ctx = canvas.getContext('2d');
        const swatches = document.querySelectorAll('.color-swatch');
        let originalImageData = null;
        let clothData = null;
        let personData = null;

        function setupCanvas() {
            canvas.width = resultImage.offsetWidth;
            canvas.height = resultImage.offsetHeight;
            ctx.drawImage(resultImage, 0, 0, canvas.width, canvas.height);
            originalImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            if (clothUrl) loadMask(clothUrl, data => clothData = data);
            if (personUrl) loadMask(personUrl, data => personData = data);
        }
        resultImage.onload = setupCanvas;
        if (resultImage.complete) setupCanvas();

        function loadMask(maskUrl, callback) {
            const maskImg = new Image();
            maskImg.crossOrigin = 'anonymous';
            maskImg.onload = function() {
                const maskCanvas = document.createElement('canvas');
                const maskCtx = maskCanvas.getContext('2d');
                maskCanvas.width = canvas.width;
                maskCanvas.height = canvas.height;
                maskCtx.drawImage(maskImg, 0, 0, canvas.width, canvas.height);
                const maskData = maskCtx.getImageData(0, 0, canvas.width, canvas.height);
                callback(maskData.data);
            };
            maskImg.src = maskUrl;
        }

        swatches.forEach(swatch => {
            swatch.addEventListener('click', function() {
                swatches.forEach(s => s.classList.remove('selected'));
                this.classList.add('selected');
                const color = hexToRgb(swatch.dataset.color || swatch.style.backgroundColor);
                applyColorToClothing(color);
            });
        });

        function applyColorToClothing(colorHex) {
            if (!originalImageData) return;
            const imageData = ctx.createImageData(originalImageData);
            const data = imageData.data;
            const originalData = originalImageData.data;
            const rgb = hexToRgb(colorHex);
            if (!rgb) return;

            for (let i = 0; i < data.length; i += 4) {
                const maskCloth = clothData && clothData[i] > 128;
                const maskPerson = personData && personData[i] > 128;

                if (maskCloth) {
                    data[i]     = Math.min(255, originalData[i]     * rgb.r / 128);
                    data[i + 1] = Math.min(255, originalData[i + 1] * rgb.g / 128);
                    data[i + 2] = Math.min(255, originalData[i + 2] * rgb.b / 128);
                    data[i + 3] = originalData[i + 3];
                } else if (maskPerson) {
                    data[i] = 255; data[i + 1] = 255; data[i + 2] = 255; data[i + 3] = originalData[i + 3];
                } else {
                    data[i]     = originalData[i];
                    data[i + 1] = originalData[i + 1];
                    data[i + 2] = originalData[i + 2];
                    data[i + 3] = originalData[i + 3];
                }
            }
            ctx.putImageData(imageData, 0, 0);
        }

        function hexToRgb(input) {
            if (input && typeof input === 'object' && input.r !== undefined) return input;
            if (typeof input !== 'string') return null;
            if (input.startsWith('rgb')) {
                const match = input.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
                return match ? { r: parseInt(match[1]), g: parseInt(match[2]), b: parseInt(match[3]) } : null;
            }
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(input);
            return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : null;
        }

        window.addEventListener('resize', function() {
            if (originalImageData) { setTimeout(setupCanvas, 100); }
        });
    }

    // 요청한 setToneDescription 삽입
    function setToneDescription() {
        const rawType = ('[[${analysis.colorType}]]' || '').toString().toLowerCase();
        const norm = rawType.includes('spring') ? 'spring'
            : rawType.includes('summer') ? 'summer'
                : rawType.includes('autumn') ? 'autumn'
                    : rawType.includes('winter') ? 'winter'
                        : '';

        const box = document.getElementById("toneDescriptionBox");
        const toneDescriptions = {
            "spring": {
                이름: "🌸 봄 웜톤",
                특징: "밝고 투명, 따뜻하고 생기 있는 컬러.",
                추천: "라이트 옐로우, 아이보리, 크림 베이지 / 코랄, 피치, 살몬 핑크 / 민트, 아쿠아, 터키옥",
                피해야: "블랙, 다크브라운, 네이비 / 푸른 보라, 아이시 블루",
                헤어: "라이트 브라운, 허니 브라운, 골드 브라운",
                메이크업: "코랄/피치 립, 오렌지 브라운 섀도, 골드 펄 하이라이터"
            },
            "summer": {
                이름: "🌊 여름 쿨톤",
                특징: "차분하고 부드러운 파스텔톤, 흐릿하고 소프트한 컬러.",
                추천: "라벤더, 소프트 핑크, 베이비 블루, 민트 / 쿨 그레이, 퓨어 화이트 / 체리 핑크, 로즈, 딥 라즈베리",
                피해야: "머스터드, 올리브, 오렌지 레드 / 블랙처럼 강한 대비 색상",
                헤어: "애쉬 브라운, 소프트 블랙, 네이비 블랙",
                메이크업: "로즈/핑크 립, 라벤더·쿨브라운 섀도, 실버 펄"
            },
            "autumn": {
                이름: "🍁 가을 웜톤",
                특징: "깊고 그윽하며 따뜻한 가을 숲·대지 색.",
                추천: "머스터드, 카멜, 코코아, 초콜릿 브라운 / 테라코타, 브릭 레드, 버건디 / 올리브, 카키, 포레스트 그린",
                피해야: "파스텔톤, 퓨어 화이트, 형광색",
                헤어: "다크 브라운, 모카, 레드 브라운",
                메이크업: "브릭·테라코타 립, 브론즈 섀도, 골드 펄"
            },
            "winter": {
                이름: "❄ 겨울 쿨톤",
                특징: "선명하고 차갑고 강한 대비, 고채도 & 딥 컬러.",
                추천: "블랙, 퓨어 화이트 / 푸시아, 딥 레드, 체리, 루비 / 코발트 블루, 에메랄드, 퍼플",
                피해야: "머스터드, 카멜, 오렌지 / 톤 다운된 베이지, 올리브",
                헤어: "블랙, 블루블랙, 다크 애쉬",
                메이크업: "레드/푸시아 립, 스모키 블랙 아이, 화이트 하이라이터"
            }
        };

        if (!box) return;
        const tone = toneDescriptions[norm];
        if (!tone) {
            box.innerHTML = "<p>추천 설명을 찾을 수 없습니다.</p>";
            return;
        }

        box.innerHTML = `
            <button type="button" class="close-btn" onclick="closeToneDescription()">추천 닫기</button>
            <h3>${tone.이름}</h3>
            <p><b>특징:</b> ${tone.특징}</p>
            <p><b>추천 색상:</b> ${tone.추천}</p>
            <p><b>피해야 할 색상:</b> ${tone.피해야}</p>
            <p><b>헤어 색상:</b> ${tone.헤어}</p>
            <p><b>메이크업:</b> ${tone.메이크업}</p>
        `;
    }
</script>
</body>
</html>
